<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <link rel="shortcut icon" href="favoritesicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"
    integrity="sha512-FwNWaxyfy2XlEINoSnZh1JQ5TRRtGow0D6XcmAWmYCRgvqOUTnzCxPc9uF35u5ZEpirk1uhlPVA19tflhvnW1g=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/relativeTime.min.js"
    integrity="sha512-MVzDPmm7QZ8PhEiqJXKz/zw2HJuv61waxb8XXuZMMs9b+an3LoqOqhOEt5Nq3LY1e4Ipbbd/e+AWgERdHlVgaA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <title>To Do</title>
  <style>
    html {
      font-family: sans-serif;
    }

    table,
    th,
    td {
      border: 1px solid black;
      border-collapse: collapse;
    }
  </style>
</head>

<body>
  <div id="output">
  </div>
  <script type="text/javascript">
    dayjs.extend(window.dayjs_plugin_relativeTime)
    var toDos;
    const queryString = window.location.search;
    const dayMs = 1000 * 60 * 60 * 24;
    const urlParams = new URLSearchParams(queryString);
    const token = urlParams.get("token");
    const file_id = urlParams.get("file_id");
    const node_id = urlParams.get("node_id");


    var topNodeDate = (nodeId) => (async () => {
      var self = toDos.filter((item) => item.id === nodeId)[0];
      self.dated = new Date().getTime();
      sortGrid();
      await saveData(toDos);
      redrawGrid();
    })();
    var shiftNodeDate = (nodeId, ms) => (async () => {
      var self = toDos.filter((item) => item.id === nodeId)[0];
      self.dated += ms;
      sortGrid();
      await saveData(toDos);
      redrawGrid();
    })();
    var deleteNode = (nodeId) => (async () => {
      toDos = toDos.filter((item) => item.id !== nodeId);
      await saveData(toDos);
      redrawGrid();
    })();

    var updateNode = (nodeId) => (async () => {
      var self = toDos.filter((item) => item.id === nodeId)[0];
      var answer = prompt("Edit Text", self.text);
      if (!answer) return;
      self.text = answer;
      await saveData(toDos);
      redrawGrid();
    })();

    /////////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////////
    async function getJsonString() {
      const response = await fetch("https://dynalist.io/api/v1/doc/read", {
        method: "POST",
        headers: {
          Accept: "application/json",
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          token: token,
          file_id: file_id,
        }),
      });
      const rObject = await response.json();
      const rawNodeText = (rObject).nodes.filter((item) => item.id === node_id)[0].content;
      return rawNodeText.substring(1, rawNodeText.length - 1);
    }
    async function saveJsonString(jsonString) {
      const response = await fetch("https://dynalist.io/api/v1/doc/edit", {
        method: "POST",
        headers: {
          Accept: "application/json",
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          token: token,
          file_id: file_id,
          changes: [{
            action: "edit",
            node_id: node_id,
            content: "`" + jsonString + "`",
          }],
        }),
      });
    }
    const getData = async () => JSON.parse(await getJsonString());
    const saveData = async (data) => await saveJsonString(JSON.stringify(data));
    /////////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////////

    function redrawGrid() {
      var newInnerHtml = `<table style="width: 100%">`;
      newInnerHtml += `<tr>`;
      newInnerHtml += `<td colspan="4"><input autocomplete="off" id="addyBox" type="text" style="width: 100%; box-sizing: border-box;" onkeypress="inputKeypress(this)"/></td>`;
      newInnerHtml += `</tr>`;
      var nowStamp = new Date().getTime();
      for (const toDo of toDos) {
        var fontvw = (3 / (((nowStamp - toDo.dated) / (dayMs)) + 1)) + 0.6;
        var styleType = `style="font-size: ${fontvw}vw;vertical-align:middle;" type="button"`
        var bgColor = "#"+(Math.floor(toDo.id * 10) % (256*256*256)).toString(16).padStart(6, '0');
        newInnerHtml += `<tr style="background: ${bgColor};">`;
        newInnerHtml += `<td><button ${styleType} onclick="updateNode(${toDo.id})">${toDo.text}</button>`;
        fontvw = (1 / (((nowStamp - toDo.dated) / (dayMs/2)) + 1)) + 0.8;
        newInnerHtml += `<span style="opacity:.5;"><span style="background:white;border-radius:${fontvw/5}vw;padding:${fontvw/5}vw;margin:${fontvw/5}vw;font-size: ${fontvw}vw;">${dayjs((toDo.dated)).fromNow()}</span>`;
        styleType = `style="font-size: ${fontvw}vw;" type="button"`
        newInnerHtml += `<button ${styleType} onclick="deleteNode(${toDo.id})">Delete</button>`;
        styleType = `style="font-size: ${fontvw}vw;background: #ffcccc" type="button"`
        newInnerHtml += `<button ${styleType} onclick="shiftNodeDate(${toDo.id}, -${dayMs/24})">ðŸ”½1 hour</button>`;
        newInnerHtml += `<button ${styleType} onclick="shiftNodeDate(${toDo.id}, ${dayMs/24})">ðŸ”¼1 hour</button>`;
        styleType = `style="font-size: ${fontvw}vw;background: #ffffcc" type="button"`
        newInnerHtml += `<button ${styleType} onclick="shiftNodeDate(${toDo.id}, -${dayMs})">ðŸ”½1 day</button>`;
        newInnerHtml += `<button ${styleType} onclick="shiftNodeDate(${toDo.id}, ${dayMs})">ðŸ”¼1 day</button>`;
        styleType = `style="font-size: ${fontvw}vw;background: #ccffcc" type="button"`
        newInnerHtml += `<button ${styleType} onclick="topNodeDate(${toDo.id})">top</button></span></td>`;
        newInnerHtml += `</tr>`;
      }
      newInnerHtml += `</table>`;
      document.getElementById("output").innerHTML = newInnerHtml;
      document.getElementById("addyBox").focus();
    }
    /////////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////////

    function sortGrid() {
      toDos = toDos.sort((a, b) => b.dated - a.dated);
    }
    function inputKeypress(ele) {
      if (event.keyCode === 13) {
        (async () => {
          toDos.push({
            text: ele.value,
            id: (new Date).getTime(),
            dated: (new Date).getTime(),
          });
          sortGrid();
          await saveData(toDos);
          redrawGrid();
        })();
      }
    }
    (async () => {
      toDos = await getData();
      sortGrid();
      redrawGrid();
    })();
  </script>
</body>

</html>